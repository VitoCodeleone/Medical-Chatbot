<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Link to the external CSS file -->
    <link rel="stylesheet" href="{{url_for('static', filename='style.css')}}" />
    <title>{{ title }}</title>
  </head>
  <body>
    <div class="chat-container">
      <header>
        <h1>Chatbot</h1>
        <div class="login-info">
          <p>{{ email }}</p>
          <a href="{{url_for('logout')}}">Logout</a>
        </div>
      </header>
      <div class="chat-hero">
        <div class="container">
          <div class="infobar">
            <p></p>
            <img src="{{url_for('static', filename='nurse.png')}}" alt="" />
            <h2>Ask me anything!</h2>
          </div>

          <div class="messageArea"></div>

          <div class="messageInput">
            <form action="{{url_for('reply')}}" id="userForm" method="post">
              <input
                type="text"
                name="msg"
                id="msg"
                placeholder="Type your message..."
                required
                autocomplete="off"
              />
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      var date = new Date();
      var appendZero = (unit) => {
        return (unit < 10 ? "0" : "") + unit;
      };
      var dateText =
        appendZero(date.getHours()) + ":" + appendZero(date.getMinutes());

      document
        .getElementById("userForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();

          const msgbox = document.getElementById("msg");
          const userText = msgbox.value;
          msgbox.value = "";

          var messageArea = document.getElementsByClassName("messageArea")[0];

          messageArea.innerHTML += `<div class="messageContainer user">
          <div class="messageInfo">
            <img src="{{url_for('static', filename='user.png')}}" alt="" />
            <h5>${dateText}</h5>
          </div>
          <div class="message message-user">${userText}</div>
        </div>`;

          const jsonData = {
            msg: userText,
          };

          const options = {
            method: "POST",
            headers: {
              "Content-type": "application/json",
            },
            body: JSON.stringify(jsonData),
          };

          fetch("{{url_for('reply')}}", options)
            .then((resp) => {
              return resp.text();
            })
            .then((data) => {
              var curDate = new Date();
              var curTimeText =
                appendZero(curDate.getHours()) +
                ":" +
                appendZero(curDate.getMinutes());
              messageArea.innerHTML += ` <div class="messageContainer ai">
          <div class="messageInfo">
            <img src="{{url_for('static', filename='nurse.png')}}" alt="" />
            <h5>${curTimeText}</h5>
          </div>
          <div class="message message-ai">${data}</div>
        </div>`;
            });
        });
    </script>
  </body>
</html>
